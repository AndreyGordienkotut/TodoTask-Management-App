# --- CI/CD CONFIGURATION FOR GitLab ---
# –≠—Ç–∞–ø—ã:
# 1. –°–±–æ—Ä–∫–∞ Gradle
# 2. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
# 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–±–æ—Ä–∫–∏ Docker Compose
# 4. (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ docker-compose up –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏

stages:
  - build
  - test
  - docker
  - deploy

# === BUILD STAGE ===
#build:
#  stage: build
#  image: gradle:8.4-jdk17
#  script:
#    - chmod +x ./gradlew
#    - echo "üî® Building project..."
#    - ./gradlew clean build -x test --no-daemon
#  artifacts:
#    paths:
#      - build/libs/
#  only:
#    - master
#    - merge_requests
build:
  stage: build
  image: gradle:8.4-jdk17
  script:
    - chmod +x ./gradlew
    - echo "üî® Building project..."
    - ./gradlew clean :userService:bootJar :taskService:bootJar :notificationService:bootJar :eureka-server:bootJar --no-daemon
  artifacts:
    paths:
      - "**/build/libs/"
  only:
    - master
    - merge_requests

# === TEST STAGE ===
#test:
#  stage: test
#  image: gradle:8.4-jdk17
#  script:
#    - chmod +x ./gradlew
#    - echo "üß™ Running tests..."
#    - ./gradlew test --no-daemon
#  artifacts:
#    reports:
#      junit: build/test-results/test/TEST-*.xml
#  only:
#    - master
#    - merge_requests
test:
  stage: test
  image: gradle:8.4-jdk17
  script:
    # *** –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ü–†–ê–í: –î–∞–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç—É gradlew ***
    - chmod +x ./gradlew
    - echo "üß™ Running tests..."
    # –î–ª—è —Ç–µ—Å—Ç–æ–≤ –≤—Å–µ –µ—â–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â—É—é –∫–æ–º–∞–Ω–¥—É, –∫–æ—Ç–æ—Ä–∞—è –∑–∞–ø—É—Å—Ç–∏—Ç —Ç–µ—Å—Ç—ã –¥–ª—è –≤—Å–µ—Ö –ø–æ–¥–º–æ–¥—É–ª–µ–π
    - ./gradlew test --no-daemon
  artifacts:
    reports:
      junit: build/test-results/**/TEST-*.xml # –ò–∑–º–µ–Ω—è–µ–º –ø—É—Ç—å –¥–ª—è –º—É–ª—å—Ç–∏–º–æ–¥—É–ª—å–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
  only:
    - master
    - merge_requests

# === DOCKER BUILD STAGE ===
docker-build:
  stage: docker
  image: docker:27.0.3
  services:
    - docker:dind
  script:
    - chmod +x ./gradlew
    - echo "üê≥ Building Docker images with Docker Compose..."
    - docker compose -f docker-compose.yml build
  only:
    - master

# === DEPLOY STAGE (optional, manual) ===
deploy:
  stage: deploy
  image: docker:27.0.3
  services:
    - docker:dind
  script:
    - echo "üöÄ Starting containers for testing..."
    - docker compose -f docker-compose.yml up -d
    - docker ps
  when: manual
  only:
    - master
